# UPS Battery Monitor

Скрипт для мониторинга батареи ИБП на Windows. Отслеживает отключение и восстановление питания, отправляет уведомления в Telegram и выключает ПК при низком заряде. Логи сохраняются в файл.

## Описание

- Отслеживает батарею (заряд, подключение, время) через WMI (`win32com.client`).
- Логирует события в файл, указанный в `config.ini` (`LOG_FILE`).
- Уведомления в Telegram:
  - Отключение питания.
  - Восстановление.
  - Низкий заряд (с автоматическим выключением ПК).
- Запускается через Планировщик задач, чтобы не работать в фоне постоянно.

Пример Telegram-уведомления:
```
30.05.2025 16:23:45 - Отключение электричества!
Заряд: 98%, осталось: 10 мин.
```

Пример лога:
```
=== Лог за 30.05.2025 ===
30.05.2025 16:23:45 - Отключение электричества! Заряд: 98%, осталось: 10 мин.
```

## Требования

- **ОС**: Windows 10/11 (64-бит).
- **Python**: Портативная версия включена в релизе или Python 3.6+ для ручной установки.
- **Telegram**: Бот (создайте через [@BotFather](https://t.me/BotFather)), ID чата (узнайте через [@userinfobot](https://t.me/userinfobot)).
- **ИБП**: Подключён к ПК по USB и отображается в Диспетчере устройств как "Батарея ИБП HID" (стандартный драйвер Windows).

## Установка

### Вариант 1: Портативная версия (рекомендуется)
1. **Скачайте архив**:
   - Перейдите в раздел [Releases](https://github.com/VladDmi94/ups-battery-monitor/releases).
   - Скачайте `UPSBatteryMonitor.zip` и распакуйте в папку, например, `C:\путь_к_папке\UPSBatteryMonitor`.
   - Архив содержит:
     - `PythonEmbedded` (портативная версия Python с зависимостями).
     - `config.ini` (файл конфигурации).
     - `ups_log.txt` (файл логов по умолчанию).
     - `ups-battery-monitor.py` (основной скрипт).
2. **Настройте `config.ini`**:
   - Откройте `C:\путь_к_папке\UPSBatteryMonitor\config.ini` в текстовом редакторе.
   - Укажите ваши `TELEGRAM_TOKEN` и `TELEGRAM_CHAT_ID`:
     ```ini
     TELEGRAM_TOKEN = ваш_токен
     TELEGRAM_CHAT_ID = ваш_чат_id
     ```
   - Остальные параметры (`CHECK_INTERVAL`, `DELAY_NOTIFY`, `LOG_FILE`, `SHUTDOWN_THRESHOLD`, `SHUTDOWN_TIMEOUT`) можно оставить или изменить по желанию.
3. **Настройка задания в Планировщике задач**:
   - Откройте **Планировщик задач** (Win+R, введите `taskschd.msc`).
   - **Создайте новое задание**:
     - В правой панели выберите **Создать задачу**.
   - **Вкладка "Общее"**:
     - Дайте имя, например, `UPS Battery Monitor`.
     - Установите флажок **Выполнять с наивысшими правами**.
   - **Вкладка "Триггеры"**:
     - Нажмите **Создать** → выберите **При событии**.
     - В разделе **Параметры** выберите **Настраиваемое** → **Создать фильтр события**.
     - Перейдите на вкладку **XML**, включите **Изменить запрос вручную** → подтвердите **Да**.
     - Вставьте код:
       ```xml
       <QueryList>
         <Query Id="0" Path="System">
           <Select Path="System">
             *[System[Provider[@Name='Microsoft-Windows-Kernel-Power'] and (EventID=105)]]
             and
             *[EventData[Data[@Name='AcOnline']='false']]
           </Select>
         </Query>
       </QueryList>
       ```
     - Нажмите **ОК** → **ОК**.
   - **Вкладка "Действия"**:
     - Нажмите **Создать** → выберите **Запуск программы**.
     - В поле **Программа или сценарий**:
       ```
       "C:\путь_к_папке\UPSBatteryMonitor\PythonEmbedded\pythonw.exe"
       ```
       (кавычки, если путь содержит пробелы).
     - В поле **Добавить аргументы**:
       ```
       C:\путь_к_папке\UPSBatteryMonitor\ups-battery-monitor.py
       ```
     - В поле **Рабочая папка**:
       ```
       C:\путь_к_папке\UPSBatteryMonitor\
       ```
     - Нажмите **ОК**.
   - **Вкладка "Условия"**:
     - Снимите все флажки.
   - **Вкладка "Параметры"**:
     - Включите только **Выполнять задачу по требованию**.
   - Нажмите **ОК** для сохранения, при необходимости введите учётные данные администратора.
4. **Тест скрипта**:
   - Отключите питание ИБП и проверьте уведомления в Telegram и записи в `ups_log.txt`.

### Вариант 2: Ручная установка с Python 3.6+
1. **Установите зависимости**:
   - Убедитесь, что Python 3.6+ установлен и добавлен в PATH.
   - Выполните:
     ```bash
     pip install pywin32 requests
     ```
2. **Скачайте файлы**:
   - Скопируйте `ups-battery-monitor.py`, `ups_log.txt` и `config.ini` из [репозитория](https://github.com/VladDmi94/ups-battery-monitor) или релиза в папку, например, `C:\путь_к_папке\UPSBatteryMonitor`.
3. **Настройте `config.ini`**:
   - Откройте `C:\путь_к_папке\UPSBatteryMonitor\config.ini`.
   - Укажите `TELEGRAM_TOKEN` и `TELEGRAM_CHAT_ID` (см. **Вариант 1**).
4. **Настройка задания в Планировщике задач**:
   - Откройте **Планировщик задач** (Win+R, `taskschd.msc`).
   - **Создайте новое задание**:
     - В правой панели выберите **Создать задачу**.
   - **Вкладка "Общее"**:
     - Дайте имя, например, `UPS Battery Monitor`.
     - Установите флажок **Выполнять с наивысшими правами**.
   - **Вкладка "Триггеры"**:
     - Нажмите **Создать** → выберите **При событии**.
     - В разделе **Параметры** выберите **Настраиваемое** → **Создать фильтр события**.
     - Перейдите на вкладку **XML**, включите **Изменить запрос вручную** → подтвердите **Да**.
     - Вставьте код:
       ```xml
       <QueryList>
         <Query Id="0" Path="System">
           <Select Path="System">
             *[System[Provider[@Name='Microsoft-Windows-Kernel-Power'] and (EventID=105)]]
             and
             *[EventData[Data[@Name='AcOnline']='false']]
           </Select>
         </Query>
       </QueryList>
       ```
     - Нажмите **ОК** → **ОК**.
   - **Вкладка "Действия"**:
     - Нажмите **Создать** → выберите **Запуск программы**.
     - В поле **Программа или сценарий**:
       - Если Python в PATH:
         ```
         pythonw.exe
         ```
       - Иначе укажите полный путь, например:
         ```
         "C:\Python39\pythonw.exe"
         ```
         (кавычки, если путь содержит пробелы). Найдите путь командой:
         ```bash
         where python
         ```
     - В поле **Добавить аргументы**:
       ```
       C:\путь_к_папке\UPSBatteryMonitor\ups-battery-monitor.py
       ```
     - В поле **Рабочая папка**:
       ```
       C:\путь_к_папке\UPSBatteryMonitor\
       ```
     - Нажмите **ОК**.
   - **Вкладка "Условия"**:
     - Снимите все флажки.
   - **Вкладка "Параметры"**:
     - Включите только **Выполнять задачу по требованию**.
   - Нажмите **ОК**, при необходимости введите учётные данные администратора.
5. **Тест скрипта**:
   - Отключите питание ИБП и проверьте уведомления в Telegram и записи в `ups_log.txt`.

## Конфигурация
В `config.ini` (`[Settings]`):
- `TELEGRAM_TOKEN`: токен бота Telegram.
- `TELEGRAM_CHAT_ID`: ID чата Telegram.
- `CHECK_INTERVAL`: интервал проверки ИБП (сек, >0).
- `DELAY_NOTIFY`: задержка отправки уведомления (сек, ≥0).
- `LOG_FILE`: путь к файлу логов (например, `ups_log.txt`).
- `SHUTDOWN_THRESHOLD`: порог заряда для выключения ПК (%, ≥0).
- `SHUTDOWN_TIMEOUT`: время до выключения ПК (после порога заряда, сек, ≥0).

Ошибки конфигурации пишутся в `LOG_FILE` или `ups_log.txt` (если `LOG_FILE` недоступен).

## Логирование
Логи и ошибки пишутся в `LOG_FILE`:
```
=== Лог за 30.05.2025 ===
30.05.2025 16:23:45 - Отключение электричества! Заряд: 98%, осталось: 10 мин.
```
Ошибки конфигурации — в `LOG_FILE` или `ups_log.txt`.

## Тестирование
1. Отключите питание ИБП.
2. Проверьте логи в `ups_log.txt`, уведомления в Telegram, ошибки.
3. Для теста выключения ПК установите `SHUTDOWN_THRESHOLD=99`.

## Зависимости
- `pywin32` (MIT)
- `requests` (Apache 2.0)
- Зависимости: `urllib3` (MIT), `certifi` (MPL), `charset_normalizer` (MIT), `idna` (BSD)

## Замечания
- Только Windows (WMI, `shutdown`).
- `EstimatedRunTime` может быть неточным (0).
- Требуется интернет для Telegram (роутер и терминал также должны быть подключены к ИБП).
- Используется 64-битная версия Python Embedded (для 32-бит нужен другой релиз).

## Лицензия
MIT (см. `LICENSE`).
